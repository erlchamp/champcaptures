apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: champcaptures
  labels: { app: champcaptures }
spec:
  replicas: 3
  revisionHistoryLimit: 3
  progressDeadlineSeconds: 600
  selector:
    matchLabels: { app: champcaptures }
  template:
    metadata:
      labels: { app: champcaptures }
    spec:
      imagePullSecrets: [{ name: regcred }]
      securityContext:
        runAsNonRoot: true
        seccompProfile: { type: RuntimeDefault }
      containers:
        - name: web
          image: docker.io/champoi/champcaptures:latest
          ports: [{ containerPort: 8080 }]
          readinessProbe:
            httpGet: { path: /healthz, port: 8080 }   # ensure /healthz exists in the container
            initialDelaySeconds: 5
          livenessProbe:
            httpGet: { path: /healthz, port: 8080 }
            initialDelaySeconds: 15
          securityContext:
            allowPrivilegeEscalation: false
            capabilities: { drop: ["ALL"] }
            runAsNonRoot: true
  strategy:
    canary:
      steps:
        - setWeight: 10
        - pause: { duration: 180 }
        - setWeight: 50
        - pause: { duration: 300 }
        - setWeight: 100